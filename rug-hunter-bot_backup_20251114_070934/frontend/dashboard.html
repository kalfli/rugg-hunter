<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ RUG HUNTER BOT v4.0 - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0a0e27;
            --bg-card: #141830;
            --bg-hover: #1a1f3a;
            --accent-cyan: #00d4ff;
            --accent-green: #00ff88;
            --accent-red: #ff4757;
            --accent-yellow: #ffd93d;
            --accent-purple: #a78bfa;
            --text-primary: #ffffff;
            --text-secondary: #8b92b0;
            --border-color: #2a2f4a;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f1324 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(90deg, var(--bg-card), var(--bg-dark));
            border-bottom: 2px solid var(--accent-cyan);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .header-left h1 {
            font-size: 2rem;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .header-info {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .status-badge {
            display: inline-block;
            padding: 0.3rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.85rem;
        }

        .status-paper {
            background: linear-gradient(90deg, #4ade80, #22c55e);
            color: white;
        }

        .status-live {
            background: linear-gradient(90deg, #ef4444, #dc2626);
            color: white;
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.6rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(90deg, var(--accent-cyan), #0891b2);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(90deg, var(--accent-red), #dc2626);
            color: white;
        }

        .btn-success {
            background: linear-gradient(90deg, var(--accent-green), #10b981);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .container {
            max-width: 1600px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 212, 255, 0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 1rem 0;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .stat-positive {
            color: var(--accent-green);
        }

        .stat-negative {
            color: var(--accent-red);
        }

        .stat-neutral {
            color: var(--accent-cyan);
        }

        .scan-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .pulse {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .detections-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .detection-item {
            background: var(--bg-hover);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.3s;
        }

        .detection-item:hover {
            border-color: var(--accent-cyan);
            transform: translateX(4px);
        }

        .detection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .token-symbol {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent-cyan);
        }

        .confidence-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .confidence-high {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .confidence-medium {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .confidence-low {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .detection-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .settings-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-top: 1.5rem;
        }

        .setting-group {
            margin-bottom: 1.5rem;
        }

        .setting-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .setting-input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .setting-input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4a4a6a;
            transition: 0.4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background: linear-gradient(90deg, var(--accent-cyan), #0891b2);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .strategy-card {
            background: var(--bg-hover);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 1rem;
        }

        .strategy-card:hover {
            border-color: var(--accent-cyan);
            transform: scale(1.02);
        }

        .strategy-card.active {
            border-color: var(--accent-green);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), transparent);
        }

        .strategy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .strategy-name {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .strategy-desc {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .chart-container {
            height: 300px;
            margin-top: 1rem;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-cyan);
            border-radius: 4px;
        }

        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .ws-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        .ws-indicator.disconnected {
            background: var(--accent-red);
            animation: none;
        }

        .tab-container {
            display: flex;
            gap: 1rem;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .tab {
            padding: 1rem 2rem;
            cursor: pointer;
            font-weight: bold;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            color: var(--accent-cyan);
        }

        .tab.active {
            color: var(--accent-cyan);
            border-bottom-color: var(--accent-cyan);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="header">
        <div class="header-left">
            <h1>üéØ RUG HUNTER BOT v4.0</h1>
            <div class="header-info">
                <span>Mode: <span class="status-badge status-paper" id="tradingMode">PAPER</span></span>
                <span>Strat√©gie: <strong id="activeStrategy">CUSTOM</strong></span>
                <span>Uptime: <strong id="uptime">00:00:00</strong></span>
            </div>
        </div>
        <div class="header-controls">
            <button class="btn btn-success" id="toggleAutoTrade">
                ü§ñ Activer Auto-Trade
            </button>
            <button class="btn btn-danger" id="emergencyStop">
                üö® STOP D'URGENCE
            </button>
        </div>
    </div>

    <div class="container">
        <!-- TABS -->
        <div class="tab-container">
            <div class="tab active" data-tab="dashboard">üìä Dashboard</div>
            <div class="tab" data-tab="detections">üîç D√©tections</div>
            <div class="tab" data-tab="positions">üí∞ Positions</div>
            <div class="tab" data-tab="settings">‚öôÔ∏è Param√®tres</div>
            <div class="tab" data-tab="strategies">üéØ Strat√©gies</div>
        </div>

        <!-- TAB: DASHBOARD -->
        <div class="tab-content active" id="dashboard">
            <!-- STATS CARDS -->
            <div class="grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üîç Scan Status</div>
                        <div class="scan-status">
                            <div class="pulse"></div>
                            <span id="scanStatus">Scanning...</span>
                        </div>
                    </div>
                    <div class="stat-value stat-neutral" id="totalScans">0</div>
                    <div class="stat-label">Total Scans Effectu√©s</div>
                    <div style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
                        <div>Prochain scan: <strong id="nextScan">--</strong></div>
                        <div>Intervalle: <strong id="scanInterval">--</strong></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üéØ Tokens D√©tect√©s</div>
                    </div>
                    <div class="stat-value stat-neutral" id="totalDetections">0</div>
                    <div class="stat-label">Tokens Trouv√©s</div>
                    <div style="margin-top: 1rem; font-size: 0.85rem;">
                        <div style="color: var(--accent-green);">‚úÖ Pass√©s: <strong id="passedFilters">0</strong></div>
                        <div style="color: var(--accent-red);">üçØ Honeypots: <strong id="honeypotsBlocked">0</strong></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üíπ PnL Total</div>
                    </div>
                    <div class="stat-value" id="totalPnL" style="color: var(--accent-green);">$0.00</div>
                    <div class="stat-label">Profit & Loss</div>
                    <div style="margin-top: 1rem; font-size: 0.85rem;">
                        <div>ROI: <strong id="totalPnLPercent">0.00%</strong></div>
                        <div>Win Rate: <strong id="winRate">0.00%</strong></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìä Trades</div>
                    </div>
                    <div class="stat-value stat-neutral" id="totalTrades">0</div>
                    <div class="stat-label">Trades Ex√©cut√©s</div>
                    <div style="margin-top: 1rem; font-size: 0.85rem;">
                        <div style="color: var(--accent-green);">‚úÖ Gagn√©s: <strong id="tradesWon">0</strong></div>
                        <div style="color: var(--accent-red);">‚ùå Perdus: <strong id="tradesLost">0</strong></div>
                        <div style="color: var(--accent-yellow);">‚è≥ En cours: <strong id="tradesOngoing">0</strong></div>
                    </div>
                </div>
            </div>

            <!-- RECENT DETECTIONS -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üîç D√©tections R√©centes</div>
                    <span id="detectionsCount">0 tokens</span>
                </div>
                <div class="detections-list" id="detectionsList">
                    <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                        Aucune d√©tection pour le moment...
                    </p>
                </div>
            </div>
        </div>

        <!-- TAB: DETECTIONS -->
        <div class="tab-content" id="detections">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üîç Toutes les D√©tections</div>
                    <button class="btn btn-primary" onclick="loadDetections()">üîÑ Actualiser</button>
                </div>
                <div class="detections-list" id="allDetectionsList"></div>
            </div>
        </div>

        <!-- TAB: POSITIONS -->
        <div class="tab-content" id="positions">
            <div class="grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üíº Positions Actives</div>
                    </div>
                    <div class="stat-value stat-neutral" id="activePositions">0</div>
                    <div class="stat-label">Positions Ouvertes</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">üíº D√©tail des Positions</div>
                </div>
                <div id="positionsList">
                    <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                        Aucune position active
                    </p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìú Historique des Trades</div>
                </div>
                <div id="tradeHistory"></div>
            </div>
        </div>

        <!-- TAB: SETTINGS -->
        <div class="tab-content" id="settings">
            <div class="settings-panel">
                <div class="card-header">
                    <h2>‚öôÔ∏è Configuration du Bot</h2>
                    <button class="btn btn-success" onclick="saveSettings()">üíæ Sauvegarder</button>
                </div>

                <div class="settings-grid">
                    <!-- SCAN SETTINGS -->
                    <div>
                        <h3 style="margin-bottom: 1rem; color: var(--accent-cyan);">üîç Scan & D√©tection</h3>
                        
                        <div class="setting-group">
                            <label class="setting-label">
                                Intervalle de Scan (secondes)
                            </label>
                            <input type="number" class="setting-input" id="scanInterval" value="15" min="5" max="300">
                        </div>

                        <div class="setting-group">
                            <label class="setting-label">
                                Activer le scan
                            </label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="scanEnabled" checked>
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="setting-group">
                            <label class="setting-label">
                                Liquidit√© Minimale (USD)
                            </label>
                            <input type="number" class="setting-input" id="minLiquidity" value="5000">
                        </div>

                        <div class="setting-group">
                            <label class="setting-label">
                                Liquidit√© Maximale (USD)
                            </label>
                            <input type="number" class="setting-input" id="maxLiquidity" value="10000000">
                        </div>
                    </div>

                    <!-- TRADING SETTINGS -->
                    <div>
                        <h3 style="margin-bottom: 1rem; color: var(--accent-cyan);">üí∞ Trading</h3>
                        
                        <div class="setting-group">
                            <label class="setting-label">
                                Mode de Trading
                            </label>
                            <select class="setting-input" id="tradingMode">
                                <option value="PAPER">PAPER (Simulation)</option>
                                <option value="LIVE">LIVE (R√©el)</option>
                            </select>
                        </div>

                        <div class="setting-group">
                            <label class="setting-label">
                                Taille Position Max (USD)
                            </label>
                            <input type="number" class="setting-input" id="maxPositionSize" value="500">
                        </div>

                        <div class="setting-group">
                            <label class="setting-label">
                                Positions Concurrentes Max
                            </label>
                            <input type="number" class="setting-input" id="maxConcurrentPositions" value="5">
                        </div>

                        <div class="setting-group">
                            <label class="setting-label">
                                Confiance Min Auto-Trade (%)
                            </label>
                            <input type="number" class="setting-input" id="minAutoTradeConfidence" value="75">
                        </div>
                    </div>

                    <!-- RISK MANAGEMENT -->
                    <div>
                        <h3 style="margin-bottom: 1rem; color: var(--accent-cyan);">üõ°Ô∏è Gestion du Risque</h3>
                        
                        <div class="setting-group">
                            <label class="setting-label">
                                Stop Loss (%)
                            </label>
                            <input type="number" class="setting-input" id="stopLoss" value="15">
                        </div>

                        <div class="setting-group">
                            <label class="setting-label">
                                Take Profit Niveau 1 (%)
                            </label>
                            <input type="number" class="setting-input" id="takeProfit1" value="30">
                        </div>

                        <div class="setting-group">
                            <label class="setting-label">
                                Perte Quotidienne Max (%)
                            </label>
                            <input type="number" class="setting-input" id="maxDailyLoss" value="15">
                        </div>

                        <div class="setting-group">
                            <label class="setting-label">
                                Trailing Stop
                            </label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="useTrailingStop" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- BLOCKCHAINS -->
                    <div>
                        <h3 style="margin-bottom: 1rem; color: var(--accent-cyan);">‚õìÔ∏è Blockchains</h3>
                        
                        <div class="setting-group">
                            <label class="setting-label">
                                <input type="checkbox" id="enableEth" checked> Ethereum (ETH)
                            </label>
                        </div>

                        <div class="setting-group">
                            <label class="setting-label">
                                <input type="checkbox" id="enableBsc" checked> BNB Chain (BSC)
                            </label>
                        </div>

                        <div class="setting-group">
                            <label class="setting-label">
                                <input type="checkbox" id="enableSol"> Solana (SOL)
                            </label>
                        </div>

                        <div class="setting-group">
                            <label class="setting-label">
                                <input type="checkbox" id="enableBase"> Base
                            </label>
                        </div>

                        <div class="setting-group">
                            <label class="setting-label">
                                <input type="checkbox" id="enableArbitrum"> Arbitrum
                            </label>
                        </div>

                        <div class="setting-group">
                            <label class="setting-label">
                                <input type="checkbox" id="enablePolygon"> Polygon
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: STRATEGIES -->
        <div class="tab-content" id="strategies">
            <div class="settings-panel">
                <div class="card-header">
                    <h2>üéØ Strat√©gies de Trading</h2>
                </div>

                <div class="settings-grid" id="strategiesList">
                    <!-- Strategies will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- CONNECTION STATUS -->
    <div class="connection-status">
        <div class="ws-indicator" id="wsIndicator"></div>
        <span id="wsStatus">Connexion...</span>
    </div>

    <script>
        // WebSocket Connection
        let ws = null;
        let reconnectTimeout = null;

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/feed`;
            
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('‚úÖ WebSocket connected');
                document.getElementById('wsStatus').textContent = 'Connect√©';
                document.getElementById('wsIndicator').classList.remove('disconnected');
                if (reconnectTimeout) {
                    clearTimeout(reconnectTimeout);
                    reconnectTimeout = null;
                }
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                console.log('‚ùå WebSocket disconnected');
                document.getElementById('wsStatus').textContent = 'D√©connect√©';
                document.getElementById('wsIndicator').classList.add('disconnected');
                
                // Reconnect after 5 seconds
                reconnectTimeout = setTimeout(connectWebSocket, 5000);
            };
        }

        function handleWebSocketMessage(message) {
            switch(message.type) {
                case 'connected':
                    console.log('Bot connected:', message.data);
                    break;
                
                case 'stats_update':
                    updateStats(message.data);
                    break;
                
                case 'new_detection':
                    addDetection(message.data);
                    break;
                
                case 'trade_executed':
                    console.log('Trade executed:', message.data);
                    loadPositions();
                    break;
                
                case 'position_closed':
                    console.log('Position closed:', message.data);
                    loadPositions();
                    break;
                
                case 'settings_updated':
                    console.log('Settings updated');
                    break;
                
                case 'strategy_changed':
                    document.getElementById('activeStrategy').textContent = message.data.strategy;
                    break;
            }
        }

        function updateStats(stats) {
            // Scan stats
            document.getElementById('totalScans').textContent = stats.total_scans?.toLocaleString() || '0';
            document.getElementById('totalDetections').textContent = stats.total_detections?.toLocaleString() || '0';
            document.getElementById('passedFilters').textContent = stats.passed_filters?.toLocaleString() || '0';
            document.getElementById('honeypotsBlocked').textContent = stats.honeypots_blocked?.toLocaleString() || '0';
            
            // Trading stats
            document.getElementById('totalTrades').textContent = stats.trades_executed?.toLocaleString() || '0';
            document.getElementById('tradesWon').textContent = stats.trades_won?.toLocaleString() || '0';
            document.getElementById('tradesLost').textContent = stats.trades_lost?.toLocaleString() || '0';
            document.getElementById('tradesOngoing').textContent = stats.trades_ongoing?.toLocaleString() || '0';
            document.getElementById('activePositions').textContent = stats.active_positions?.toLocaleString() || '0';
            
            // PnL
            const pnl = stats.total_pnl_usd || 0;
            const pnlPercent = stats.total_pnl_percent || 0;
            const pnlEl = document.getElementById('totalPnL');
            pnlEl.textContent = `${pnl.toFixed(2)}`;
            pnlEl.style.color = pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            
            document.getElementById('totalPnLPercent').textContent = `${pnlPercent.toFixed(2)}%`;
            document.getElementById('winRate').textContent = `${(stats.win_rate || 0).toFixed(1)}%`;
            
            // Next scan
            if (stats.next_scan_time) {
                const nextScan = new Date(stats.next_scan_time);
                const now = new Date();
                const diff = Math.max(0, Math.floor((nextScan - now) / 1000));
                document.getElementById('nextScan').textContent = `${diff}s`;
            }
        }

        function addDetection(detection) {
            const list = document.getElementById('detectionsList');
            
            // Remove "no detections" message
            if (list.querySelector('p')) {
                list.innerHTML = '';
            }
            
            const confidenceClass = detection.reliability_score >= 75 ? 'confidence-high' : 
                                    detection.reliability_score >= 50 ? 'confidence-medium' : 
                                    'confidence-low';
            
            const item = document.createElement('div');
            item.className = 'detection-item';
            item.innerHTML = `
                <div class="detection-header">
                    <div>
                        <span class="token-symbol">${detection.symbol}</span>
                        <span style="color: var(--text-secondary); font-size: 0.9rem; margin-left: 0.5rem;">${detection.chain}</span>
                    </div>
                    <span class="confidence-badge ${confidenceClass}">${detection.reliability_score}% üéØ</span>
                </div>
                <div class="detection-details">
                    <div>üíß Liquidit√©: ${detection.liquidity_usd?.toLocaleString()}</div>
                    <div>üí∞ Prix: ${detection.price_usd?.toFixed(8)}</div>
                    <div>üë• Holders: ${detection.holders_count}</div>
                    <div>‚è∞ √Çge: ${detection.token_age_minutes}min</div>
                    <div>üìä Market Cap: ${detection.market_cap_usd?.toLocaleString()}</div>
                    <div>üìà Volume 24h: ${detection.volume_24h_usd?.toLocaleString()}</div>
                </div>
                <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color); font-size: 0.85rem;">
                    <div style="color: var(--text-secondary);">
                        üçØ Buy Tax: ${detection.honeypot_check?.buy_tax}% | Sell Tax: ${detection.honeypot_check?.sell_tax}%
                    </div>
                    <div style="margin-top: 0.3rem; color: var(--text-secondary);">
                        üìç ${detection.token_address}
                    </div>
                </div>
            `;
            
            list.insertBefore(item, list.firstChild);
            
            // Limit to 20 detections
            while (list.children.length > 20) {
                list.removeChild(list.lastChild);
            }
            
            // Update count
            document.getElementById('detectionsCount').textContent = `${list.children.length} tokens`;
        }

        // Load all detections
        async function loadDetections() {
            try {
                const response = await fetch('/api/detections?limit=50');
                const data = await response.json();
                
                const list = document.getElementById('allDetectionsList');
                list.innerHTML = '';
                
                if (data.detections.length === 0) {
                    list.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">Aucune d√©tection</p>';
                    return;
                }
                
                data.detections.forEach(detection => {
                    const confidenceClass = detection.reliability_score >= 75 ? 'confidence-high' : 
                                            detection.reliability_score >= 50 ? 'confidence-medium' : 
                                            'confidence-low';
                    
                    const item = document.createElement('div');
                    item.className = 'detection-item';
                    item.innerHTML = `
                        <div class="detection-header">
                            <div>
                                <span class="token-symbol">${detection.symbol}</span>
                                <span style="color: var(--text-secondary); font-size: 0.9rem; margin-left: 0.5rem;">${detection.chain}</span>
                            </div>
                            <span class="confidence-badge ${confidenceClass}">${detection.reliability_score}% üéØ</span>
                        </div>
                        <div class="detection-details">
                            <div>üíß Liquidit√©: ${detection.liquidity_usd?.toLocaleString()}</div>
                            <div>üí∞ Prix: ${detection.price_usd?.toFixed(8)}</div>
                            <div>üë• Holders: ${detection.holders_count}</div>
                            <div>‚è∞ √Çge: ${detection.token_age_minutes}min</div>
                            <div>üìä Market Cap: ${detection.market_cap_usd?.toLocaleString()}</div>
                            <div>üìà Volume 24h: ${detection.volume_24h_usd?.toLocaleString()}</div>
                        </div>
                    `;
                    list.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading detections:', error);
            }
        }

        // Load positions
        async function loadPositions() {
            try {
                const response = await fetch('/api/positions');
                const data = await response.json();
                
                const list = document.getElementById('positionsList');
                list.innerHTML = '';
                
                if (data.positions.length === 0) {
                    list.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">Aucune position active</p>';
                    return;
                }
                
                data.positions.forEach(position => {
                    const item = document.createElement('div');
                    item.className = 'detection-item';
                    item.innerHTML = `
                        <div class="detection-header">
                            <div>
                                <span class="token-symbol">${position.token_symbol}</span>
                                <span style="color: var(--text-secondary); font-size: 0.9rem; margin-left: 0.5rem;">${position.mode}</span>
                            </div>
                            <span class="confidence-badge confidence-medium">${position.status}</span>
                        </div>
                        <div class="detection-details">
                            <div>üí∞ Montant: ${position.amount_usd?.toFixed(2)}</div>
                            <div>üìä Entry: ${position.price_entry?.toFixed(8)}</div>
                            <div>‚è∞ Ouvert: ${new Date(position.timestamp_open).toLocaleString()}</div>
                            <div>üìç ${position.token_address}</div>
                        </div>
                    `;
                    list.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading positions:', error);
            }
        }

        // Load strategies
        async function loadStrategies() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();
                
                const list = document.getElementById('strategiesList');
                list.innerHTML = '';
                
                // Add CUSTOM strategy
                const customCard = document.createElement('div');
                customCard.className = 'strategy-card';
                if (data.settings.ACTIVE_STRATEGY === 'CUSTOM') {
                    customCard.classList.add('active');
                }
                customCard.innerHTML = `
                    <div class="strategy-header">
                        <div class="strategy-name">‚öôÔ∏è CUSTOM - Configuration Personnalis√©e</div>
                    </div>
                    <div class="strategy-desc">Utilisez vos propres param√®tres personnalis√©s</div>
                `;
                customCard.onclick = () => applyStrategy('CUSTOM');
                list.appendChild(customCard);
                
                // Add predefined strategies
                Object.entries(data.strategies).forEach(([key, strategy]) => {
                    const card = document.createElement('div');
                    card.className = 'strategy-card';
                    if (data.settings.ACTIVE_STRATEGY === key) {
                        card.classList.add('active');
                    }
                    
                    const riskColors = {
                        'VERY_LOW': 'var(--accent-green)',
                        'LOW': 'var(--accent-green)',
                        'MEDIUM': 'var(--accent-yellow)',
                        'HIGH': 'var(--accent-red)',
                        'EXTREME': 'var(--accent-red)'
                    };
                    
                    card.innerHTML = `
                        <div class="strategy-header">
                            <div class="strategy-name">${strategy.emoji} ${strategy.name}</div>
                            <span style="color: ${riskColors[strategy.risk_level]}; font-weight: bold; font-size: 0.85rem;">
                                ${strategy.risk_level}
                            </span>
                        </div>
                        <div class="strategy-desc">${strategy.description}</div>
                    `;
                    card.onclick = () => applyStrategy(key);
                    list.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading strategies:', error);
            }
        }

        // Apply strategy
        async function applyStrategy(strategyName) {
            try {
                const response = await fetch('/api/strategy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ strategy: strategyName })
                });
                
                if (response.ok) {
                    alert(`‚úÖ Strat√©gie "${strategyName}" appliqu√©e avec succ√®s!`);
                    loadStrategies();
                    loadSettings();
                }
            } catch (error) {
                console.error('Error applying strategy:', error);
                alert('‚ùå Erreur lors de l\'application de la strat√©gie');
            }
        }

        // Load settings
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();
                const settings = data.settings;
                
                // Update all setting fields
                document.getElementById('scanInterval').value = settings.SCAN_INTERVAL_SECONDS || 15;
                document.getElementById('scanEnabled').checked = settings.SCAN_ENABLED;
                document.getElementById('minLiquidity').value = settings.MIN_LIQUIDITY_USD || 5000;
                document.getElementById('maxLiquidity').value = settings.MAX_LIQUIDITY_USD || 10000000;
                document.getElementById('tradingMode').value = settings.TRADING_MODE || 'PAPER';
                document.getElementById('maxPositionSize').value = settings.MAX_POSITION_SIZE_USD || 500;
                document.getElementById('maxConcurrentPositions').value = settings.MAX_CONCURRENT_POSITIONS || 5;
                document.getElementById('minAutoTradeConfidence').value = settings.MIN_AUTO_TRADE_CONFIDENCE || 75;
                document.getElementById('stopLoss').value = settings.STOP_LOSS_PERCENT || 15;
                document.getElementById('takeProfit1').value = settings.TAKE_PROFIT_1_PERCENT || 30;
                document.getElementById('maxDailyLoss').value = settings.MAX_DAILY_LOSS_PERCENT || 15;
                document.getElementById('useTrailingStop').checked = settings.USE_TRAILING_STOP;
                document.getElementById('enableEth').checked = settings.ENABLE_ETH_DETECTION;
                document.getElementById('enableBsc').checked = settings.ENABLE_BSC_DETECTION;
                document.getElementById('enableSol').checked = settings.ENABLE_SOL_DETECTION;
                document.getElementById('enableBase').checked = settings.ENABLE_BASE_DETECTION;
                document.getElementById('enableArbitrum').checked = settings.ENABLE_ARBITRUM_DETECTION;
                document.getElementById('enablePolygon').checked = settings.ENABLE_POLYGON_DETECTION;
                
                // Update header
                document.getElementById('activeStrategy').textContent = settings.ACTIVE_STRATEGY;
                const modeEl = document.getElementById('tradingMode');
                modeEl.textContent = settings.TRADING_MODE;
                modeEl.className = settings.TRADING_MODE === 'PAPER' ? 'status-badge status-paper' : 'status-badge status-live';
                
                // Update scan interval display
                document.getElementById('scanInterval').textContent = `${settings.SCAN_INTERVAL_SECONDS}s`;
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Save settings
        async function saveSettings() {
            try {
                const settings = {
                    SCAN_INTERVAL_SECONDS: parseInt(document.getElementById('scanInterval').value),
                    SCAN_ENABLED: document.getElementById('scanEnabled').checked,
                    MIN_LIQUIDITY_USD: parseFloat(document.getElementById('minLiquidity').value),
                    MAX_LIQUIDITY_USD: parseFloat(document.getElementById('maxLiquidity').value),
                    TRADING_MODE: document.getElementById('tradingMode').value,
                    MAX_POSITION_SIZE_USD: parseFloat(document.getElementById('maxPositionSize').value),
                    MAX_CONCURRENT_POSITIONS: parseInt(document.getElementById('maxConcurrentPositions').value),
                    MIN_AUTO_TRADE_CONFIDENCE: parseInt(document.getElementById('minAutoTradeConfidence').value),
                    STOP_LOSS_PERCENT: parseFloat(document.getElementById('stopLoss').value),
                    TAKE_PROFIT_1_PERCENT: parseFloat(document.getElementById('takeProfit1').value),
                    MAX_DAILY_LOSS_PERCENT: parseFloat(document.getElementById('maxDailyLoss').value),
                    USE_TRAILING_STOP: document.getElementById('useTrailingStop').checked,
                    ENABLE_ETH_DETECTION: document.getElementById('enableEth').checked,
                    ENABLE_BSC_DETECTION: document.getElementById('enableBsc').checked,
                    ENABLE_SOL_DETECTION: document.getElementById('enableSol').checked,
                    ENABLE_BASE_DETECTION: document.getElementById('enableBase').checked,
                    ENABLE_ARBITRUM_DETECTION: document.getElementById('enableArbitrum').checked,
                    ENABLE_POLYGON_DETECTION: document.getElementById('enablePolygon').checked,
                };
                
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                if (response.ok) {
                    alert('‚úÖ Param√®tres sauvegard√©s avec succ√®s!');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('‚ùå Erreur lors de la sauvegarde');
            }
        }

        // Toggle auto-trade
        document.getElementById('toggleAutoTrade').onclick = async function() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();
                const currentState = data.settings.AUTO_TRADING_ENABLED;
                
                await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ AUTO_TRADING_ENABLED: !currentState })
                });
                
                this.textContent = currentState ? 'ü§ñ Activer Auto-Trade' : 'üõë D√©sactiver Auto-Trade';
                this.className = currentState ? 'btn btn-success' : 'btn btn-danger';
            } catch (error) {
                console.error('Error toggling auto-trade:', error);
            }
        };

        // Emergency stop
        document.getElementById('emergencyStop').onclick = async function() {
            if (!confirm('‚ö†Ô∏è Voulez-vous vraiment arr√™ter le bot ?')) return;
            
            try {
                await fetch('/api/emergency/stop', { method: 'POST' });
                alert('üö® Bot arr√™t√©!');
            } catch (error) {
                console.error('Error stopping bot:', error);
            }
        };

        // Tab navigation
        document.querySelectorAll('.tab').forEach(tab => {
            tab.onclick = function() {
                const targetTab = this.dataset.tab;
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
                
                // Load data when switching tabs
                if (targetTab === 'detections') loadDetections();
                if (targetTab === 'positions') loadPositions();
                if (targetTab === 'strategies') loadStrategies();
                if (targetTab === 'settings') loadSettings();
            };
        });

        // Update uptime
        let startTime = Date.now();
        setInterval(() => {
            const uptime = Date.now() - startTime;
            const hours = Math.floor(uptime / 3600000);
            const minutes = Math.floor((uptime % 3600000) / 60000);
            const seconds = Math.floor((uptime % 60000) / 1000);
            document.getElementById('uptime').textContent = 
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }, 1000);

        // Initialize
        connectWebSocket();
        loadSettings();
        loadStrategies();
        
        // Periodic updates
        setInterval(loadPositions, 10000);
    </script>
</body>
</html>
